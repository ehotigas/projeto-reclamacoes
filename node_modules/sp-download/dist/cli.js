#!/usr/bin/env node
"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
Object.defineProperty(exports, "__esModule", { value: true });
var commander_1 = require("commander");
var node_sp_auth_config_1 = require("node-sp-auth-config");
var path = require("path");
var colors = require("colors");
var Download_1 = require("./api/Download");
var logger_1 = require("./utils/logger");
commander_1.program
    .version('2.0.0')
    .usage('--url=<file ...> [options]')
    .option('-u, --url [value]', 'Full path to the file in SharePoint, required')
    .option('-o, --out [value]', 'Local directory or path to file where downloaded file should be saved, optional, default is `./`')
    .option('-s, --site [value]', 'SharePoint SPWeb url, optional, default is requested based on `url`')
    .option('-c, --conf [value]', 'Path to private configuration file')
    .option('-d, --ondemand', 'On-Demand auth request, optional')
    .option('-l, --logLevel [value]', 'Log level: Debug = 5, Verbose = 4, Info = 3 (default), Warning = 2, Error = 1, Off = 0', '3')
    .parse(process.argv);
var argv = commander_1.program;
var logger = new logger_1.Logger(logger_1.resolveLogLevel(argv.logLevel));
var download = function (context, params) {
    var _a = new Download_1.Download(context.authOptions, __assign(__assign({}, argv), { logLevel: logger_1.resolveLogLevel(argv.logLevel) })), downloadFile = _a.downloadFile, downloadFileFromSite = _a.downloadFileFromSite;
    if (typeof params.site === 'undefined') {
        return downloadFile(params.url, params.out)
            .then(function (savedToPath) {
            logger.info(params.url + " has been downloaded to " + savedToPath);
        });
    }
    else {
        return downloadFileFromSite(params.site, params.url, params.out)
            .then(function (savedToPath) {
            logger.info(params.url + " has been downloaded to " + savedToPath);
        });
    }
};
(function () {
    if (typeof argv.url === 'undefined') {
        logger.error(colors.red("'" + colors.bold('--url') + "' parameter should be provided"), colors.gray("(full path to the file in SharePoint to download)"));
        return;
    }
    if (typeof argv.out === 'undefined') {
        logger.warning(colors.yellow("'" + colors.bold('--out') + "' parameter is not provided"), colors.gray("(folder of file path to save the file to)"));
    }
    if (typeof argv.conf === 'undefined' && (argv.ondemand || '').toLowerCase() !== 'true') {
        logger.warning(colors.yellow("'" + colors.bold('--conf') + "' parameter is not provided"), colors.gray("(the default configuration path is used)"));
    }
    if ((argv.ondemand || '').toLowerCase() === 'true') {
        download({ ondemand: true }, argv)
            .catch(function (error) {
            logger.error(colors.red(colors.bold('Error:') + " " + error));
        });
    }
    else {
        var authConfSettings_1 = {
            configPath: path.resolve(argv.conf || './config/private.json'),
            defaultConfigPath: path.join(__dirname, './config/default.json'),
            encryptPassword: true,
            saveConfigOnDisk: true
        };
        var authConfig = new node_sp_auth_config_1.AuthConfig(authConfSettings_1);
        authConfig.getContext()
            .then(function (context) {
            logger.info(colors.gray("Config file: " + colors.green(authConfSettings_1.configPath)));
            if (context.siteUrl) {
                logger.info(colors.gray("SP site URL: " + colors.green(context.siteUrl)));
            }
            return download(context, argv);
        })
            .catch(function (error) {
            logger.error(colors.red(colors.bold('Error:') + " " + error));
        });
    }
})();
//# sourceMappingURL=cli.js.map